# Makefile for Xilinx Artix-7 FPGA Build
# Target: PA200T-starlite (XC7A200T)

##############################################################################
# é…ç½®
##############################################################################

PROJECT = nb_core
TOP_MODULE = cpu_single_cycle

# Vivado å®‰è£…è·¯å¾„ï¼ˆæ ¹æ®å®é™…å®‰è£…ä½ç½®è°ƒæ•´ï¼‰
VIVADO_VERSION = 2023.2
VIVADO_ROOT = /opt/Xilinx/Vivado/$(VIVADO_VERSION)
VIVADO = $(VIVADO_ROOT)/bin/vivado

# è„šæœ¬å’Œç›®å½•
BUILD_SCRIPT = scripts/build.tcl
PROGRAM_SCRIPT = scripts/program.tcl
BUILD_DIR = scripts/build

# è¾“å‡ºæ–‡ä»¶
BITSTREAM = $(BUILD_DIR)/$(PROJECT).bit

##############################################################################
# ç¯å¢ƒæ£€æŸ¥
##############################################################################

.PHONY: check-vivado
check-vivado:
	@if [ ! -f "$(VIVADO)" ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° Vivado ($(VIVADO))"; \
		echo "è¯·å®‰è£… Vivado æˆ–ä¿®æ”¹ VIVADO_ROOT å˜é‡"; \
		exit 1; \
	fi
	@echo "âœ… Vivado æ‰¾åˆ°: $(VIVADO)"
	@$(VIVADO) -version | head -n 1

##############################################################################
# æ„å»ºç›®æ ‡
##############################################################################

.PHONY: all
all: build

.PHONY: build
build: check-vivado
	@echo "================================================"
	@echo "  å¼€å§‹ FPGA æ„å»º"
	@echo "  é¡¹ç›®: $(PROJECT)"
	@echo "  é¡¶å±‚æ¨¡å—: $(TOP_MODULE)"
	@echo "================================================"
	$(VIVADO) -mode batch -source $(BUILD_SCRIPT) -notrace -log $(BUILD_DIR)/build.log -journal $(BUILD_DIR)/build.jou
	@echo ""
	@echo "âœ… æ„å»ºå®Œæˆï¼"
	@echo "ğŸ“¦ Bitstream: $(BITSTREAM)"

.PHONY: gui
gui: check-vivado
	@echo "å¯åŠ¨ Vivado GUI..."
	$(VIVADO) -source $(BUILD_SCRIPT) &

##############################################################################
# çƒ§å½•ç›®æ ‡
##############################################################################

.PHONY: program
program: check-vivado
	@if [ ! -f "$(BITSTREAM)" ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° bitstream æ–‡ä»¶"; \
		echo "è¯·å…ˆè¿è¡Œ 'make build'"; \
		exit 1; \
	fi
	@echo "çƒ§å½• FPGA..."
	$(VIVADO) -mode batch -source $(PROGRAM_SCRIPT) -notrace

##############################################################################
# æ¸…ç†ç›®æ ‡
##############################################################################

.PHONY: clean
clean:
	@echo "æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf $(BUILD_DIR)
	rm -rf .Xil
	rm -rf vivado*.jou vivado*.log
	rm -rf *.dcp *.rpt
	@echo "âœ… æ¸…ç†å®Œæˆ"

.PHONY: distclean
distclean: clean
	@echo "æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ Vivado ç¼“å­˜ï¼‰..."
	rm -rf ~/.Xilinx/Vivado/$(VIVADO_VERSION)/.Xil
	@echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"

##############################################################################
# æŠ¥å‘Šç›®æ ‡
##############################################################################

.PHONY: report
report:
	@if [ -f "$(BUILD_DIR)/post_route_timing.rpt" ]; then \
		echo "=== æ—¶åºæŠ¥å‘Š ==="; \
		head -n 50 $(BUILD_DIR)/post_route_timing.rpt; \
		echo ""; \
		echo "=== èµ„æºåˆ©ç”¨ç‡ ==="; \
		grep -A 20 "Slice Logic" $(BUILD_DIR)/post_route_util.rpt; \
	else \
		echo "âŒ æ‰¾ä¸åˆ°æŠ¥å‘Šæ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ 'make build'"; \
	fi

##############################################################################
# å¸®åŠ©ä¿¡æ¯
##############################################################################

.PHONY: help
help:
	@echo "nb-core Xilinx Artix-7 FPGA æ„å»ºç³»ç»Ÿ"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  make build       - æ„å»º bitstreamï¼ˆçº¯ CLIï¼‰"
	@echo "  make gui         - å¯åŠ¨ Vivado GUI"
	@echo "  make program     - çƒ§å½• FPGA"
	@echo "  make report      - æ˜¾ç¤ºç»¼åˆæŠ¥å‘Š"
	@echo "  make clean       - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make distclean   - æ·±åº¦æ¸…ç†"
	@echo "  make check-vivado - æ£€æŸ¥ Vivado å®‰è£…"
	@echo "  make help        - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "ç¯å¢ƒå˜é‡:"
	@echo "  VIVADO_VERSION   - Vivado ç‰ˆæœ¬ (å½“å‰: $(VIVADO_VERSION))"
	@echo "  VIVADO_ROOT      - Vivado å®‰è£…è·¯å¾„ (å½“å‰: $(VIVADO_ROOT))"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make build              # çº¯ CLI æ„å»º"
	@echo "  make VIVADO_VERSION=2024.1 build  # ä½¿ç”¨ä¸åŒç‰ˆæœ¬"

.DEFAULT_GOAL := help
